# Databricks notebook source
# MAGIC %md
# MAGIC # ğŸ§  DiagnÃ³stico Comportamental + SemÃ¢ntico dos Perfis 
# MAGIC 
# MAGIC **Objetivo**: Evitar overfitting semÃ¢ntico e atribuiÃ§Ã£o injustificada de perfis.
# MAGIC 
# MAGIC **TÃ©cnicas**: Filtros comportamentais mÃ­nimos + validaÃ§Ã£o semÃ¢ntica de categorias dominantes.
# MAGIC 
# MAGIC **Valor Gerado**: Maior robustez nos perfis atribuÃ­dos e clusters mais confiÃ¡veis para aÃ§Ãµes de negÃ³cio.

# COMMAND ----------
from pyspark.sql.functions import col, size, array_contains, countDistinct, collect_set, when

# Definir filtros comportamentais mÃ­nimos
min_visitas = 2
min_quantidade = 10

# COMMAND ----------
# ğŸ“¦ Carregamento de base tratada
clientes = spark.read.parquet("/mnt/data/clientes_filtrados_comportamentalmente")

# COMMAND ----------
# ğŸ“Š Aplicar filtro comportamental mÃ­nimo
clientes_filtrados = clientes.filter((col("frequencia") >= min_visitas) & (col("total_quantidade") >= min_quantidade))

# COMMAND ----------
# ğŸ” DiagnÃ³stico de clientes com comportamento frÃ¡gil que receberam perfil
clientes_risco = clientes.filter(
    (col("frequencia") < min_visitas) & (col("total_quantidade") < min_quantidade) & (col("perfil_nomeado").isNotNull())
)

# COMMAND ----------
# ğŸ”¬ Exemplo CrÃ­tico para Storytelling
clientes_risco.filter(col("idcliente") == 12343890).select(
    "idcliente", "perfil", "frequencia", "total_quantidade", "categorias_1", "produto"
).display()

# COMMAND ----------
# ğŸ§  ValidaÃ§Ã£o SemÃ¢ntica: identificar se categorias sÃ£o compatÃ­veis com o perfil atribuido
clientes_semantica = clientes.withColumn(
    "perfil_inconsistente",
    when(
        (col("perfil_nomeado") == "Elaborador") & ~array_contains(col("categorias_1"), "MASSAS"),
        True
    ).otherwise(False)
)

# COMMAND ----------
# ğŸ“ Casos Inconsistentes
clientes_semantica.filter(col("perfil_inconsistente") == True).select(
    "idcliente", "perfil_nomeado", "categorias_1", "produto"
).display()

# COMMAND ----------
# âœ… ConclusÃ£o: Propor aplicaÃ§Ã£o de regras complementares ao modelo de perfil
# Regras: 
# - SÃ³ atribuir perfil se passou filtro comportamental
# - Validar se categorias dominantes sÃ£o compatÃ­veis com a descriÃ§Ã£o do perfil

clientes_validados = clientes_filtrados.withColumn(
    "perfil_validado",
    when(
        (col("perfil_nomeado") == "Elaborador") & array_contains(col("categorias_1"), "MASSAS"),
        "Construtor"
    ).otherwise("Outro")
)

# COMMAND ----------
# ğŸ’¾ Exportar resultado final com validaÃ§Ã£o
clientes_validados.write.mode("overwrite").parquet("/mnt/data/clientes_perfil_validado")

# COMMAND ----------
# MAGIC %md
# MAGIC ### ğŸ“Œ ConsideraÃ§Ãµes Profissionais
# MAGIC - 32,3% dos clientes realizaram apenas uma visita
# MAGIC - 46% desses compraram menos de 10 produtos
# MAGIC - Clientes com esse comportamento frÃ¡gil receberam perfis nÃ£o compatÃ­veis semanticamente
# MAGIC - A aplicaÃ§Ã£o de regras comportamentais + validaÃ§Ã£o semÃ¢ntica gerou clusters mais coerentes
# MAGIC 
# MAGIC **ğŸ” Insight**: segmentaÃ§Ã£o nÃ£o pode ser baseada apenas em clustering estatÃ­stico, Ã© crÃ­tico combinar semÃ¢ntica + comportamento.
